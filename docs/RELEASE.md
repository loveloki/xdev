# 发布脚本使用指南

## 概述

`scripts/release.sh` 是一个自动化发布脚本，用于简化项目的版本发布流程。

## 功能特性

- ✅ 自动更新 `Cargo.toml` 版本号
- ✅ 自动更新 `CHANGELOG.md`
- ✅ 创建带时间戳的 Git 标签
- ✅ 自动推送到 GitHub
- ✅ 生成发布说明文件
- ✅ 支持试运行模式
- ✅ 版本号格式验证
- ✅ Git 状态检查

## 使用方法

### 基本用法

```bash
# 发布版本 0.1.1
./scripts/release.sh -v 0.1.1

# 发布版本并指定消息
./scripts/release.sh -v 0.1.1 -m "修复重要bug"

# 试运行模式（不实际执行）
./scripts/release.sh --dry-run -v 0.1.1
```

### 命令行选项

| 选项 | 长选项 | 描述 | 必需 |
|------|--------|------|------|
| `-v` | `--version` | 指定版本号 (例如: 0.1.1) | ✅ |
| `-m` | `--message` | 发布消息 (可选) | ❌ |
| `-d` | `--dry-run` | 试运行模式，不实际执行 | ❌ |
| `-h` | `--help` | 显示帮助信息 | ❌ |

### 版本号格式

版本号必须符合语义化版本规范：
- 格式：`主版本.次版本.修订版本`
- 示例：`0.1.1`, `1.0.0`, `2.1.3`

## 发布流程

脚本执行以下步骤：

1. **参数验证**
   - 检查版本号格式
   - 验证必需参数

2. **Git 状态检查**
   - 确认在 Git 仓库中
   - 检查未提交的更改
   - 验证远程仓库配置

3. **文件更新**
   - 更新 `Cargo.toml` 版本号
   - 更新 `CHANGELOG.md`

4. **Git 操作**
   - 提交所有更改
   - 创建带时间戳的标签

5. **推送**
   - 推送到 GitHub
   - 推送标签

6. **生成文档**
   - 创建发布说明文件

## 标签格式

脚本生成的标签格式为：
```
v{版本号}-{时间戳}
```

示例：
- `v0.1.1-20250101`

## 输出文件

### CHANGELOG.md 更新

脚本会自动更新 `CHANGELOG.md`：
- 将 `[未发布]` 部分移动到新版本
- 添加发布日期
- 保持 `[未发布]` 部分用于下次发布

## 安全特性

### 试运行模式

使用 `--dry-run` 选项可以预览发布过程而不实际执行：

```bash
./scripts/release.sh --dry-run -v 0.1.1
```

### 状态检查

脚本会检查：
- Git 仓库状态
- 未提交的更改
- 远程仓库配置

如果发现问题，会提示用户确认是否继续。

## 错误处理

脚本包含完善的错误处理：

- **版本号格式错误**：提示正确的格式
- **Git 状态问题**：显示具体问题并询问是否继续
- **文件操作失败**：显示详细错误信息
- **网络问题**：提示推送失败

## 示例

### 发布补丁版本

```bash
./scripts/release.sh -v 0.1.1 -m "修复配置文件读取问题"
```

### 发布次要版本

```bash
./scripts/release.sh -v 0.2.0 -m "新增多平台支持"
```

### 发布主要版本

```bash
./scripts/release.sh -v 1.0.0 -m "首个稳定版本发布"
```

## 注意事项

1. **权限要求**：确保有推送权限到 GitHub 仓库
2. **分支要求**：脚本假设在 `main` 分支上执行
3. **网络连接**：需要稳定的网络连接来推送到 GitHub
4. **备份建议**：发布前建议备份重要文件

## 故障排除

### 常见问题

1. **权限被拒绝**
   ```bash
   # 检查 Git 配置
   git config --list | grep user
   ```

2. **推送失败**
   ```bash
   # 检查远程仓库
   git remote -v
   ```

3. **版本号格式错误**
   ```bash
   # 使用正确的格式
   ./scripts/release.sh -v 0.1.1  # ✅
   ./scripts/release.sh -v 0.1    # ❌
   ```

### 获取帮助

```bash
./scripts/release.sh --help
```

## 集成建议

### CI/CD 集成

可以在 CI/CD 流程中使用：

```yaml
# GitHub Actions 示例
- name: Release
  run: |
    ./scripts/release.sh -v ${{ env.VERSION }} -m "${{ env.RELEASE_MESSAGE }}"
```

### 自动化发布

结合 GitHub Actions 实现自动化发布：

1. 创建 Release 分支
2. 运行发布脚本
3. 创建 GitHub Release
4. 上传构建产物

## 更新日志

- **v1.0.0**: 初始版本
  - 基础发布功能
  - 版本号验证
  - Git 标签创建
  - CHANGELOG 更新 
