name: Release

on:
  push:
    tags:
      - 'v*' # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥ 'v' å¼€å¤´çš„æ ‡ç­¾

# æ˜ç¡®å£°æ˜å·¥ä½œæµæƒé™
permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º release
  packages: write  # å¯èƒ½éœ€è¦åŒ…æƒé™

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build for ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
          - target: aarch64-unknown-linux-gnu

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: å®‰è£… cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: å®‰è£… UPX
      run: |
        sudo apt-get update
        sudo apt-get install -y upx-ucl

    - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        echo "å¼€å§‹æ„å»º ${{ matrix.target }}..."
        cross build --target ${{ matrix.target }} --release
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥æ–‡ä»¶ï¼š"
        ls -la target/${{ matrix.target }}/release/
        if [ ! -f "target/${{ matrix.target }}/release/xdev" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼"
          exit 1
        fi

    - name: å‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        mkdir -p dist
        cp target/${{ matrix.target }}/release/xdev dist/xdev-${{ matrix.target }}
        echo "å‹ç¼©å‰å¤§å°ï¼š"
        ls -lh dist/xdev-${{ matrix.target }}
        upx --best dist/xdev-${{ matrix.target }}
        echo "å‹ç¼©åå¤§å°ï¼š"
        ls -lh dist/xdev-${{ matrix.target }}

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: xdev-${{ matrix.target }}
        path: dist/xdev-${{ matrix.target }}
        if-no-files-found: error

  build-macos:
    name: Build for macOS
    runs-on: macos-latest
    strategy:
      matrix:
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£… Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        echo "å¼€å§‹æ„å»º ${{ matrix.target }}..."
        cargo build --target ${{ matrix.target }} --release
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥æ–‡ä»¶ï¼š"
        ls -la target/${{ matrix.target }}/release/
        if [ ! -f "target/${{ matrix.target }}/release/xdev" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼"
          exit 1
        fi

    - name: å®‰è£… UPX (macOS)
      run: |
        brew install upx

    - name: åˆ›å»ºåˆ†å‘ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
      run: |
        mkdir -p dist
        cp target/${{ matrix.target }}/release/xdev dist/xdev-${{ matrix.target }}
        echo "å‹ç¼©å‰å¤§å°ï¼š"
        ls -lh dist/xdev-${{ matrix.target }}
        
        # å°è¯•ä½¿ç”¨ UPX å‹ç¼© macOS äºŒè¿›åˆ¶æ–‡ä»¶
        if upx --best dist/xdev-${{ matrix.target }} 2>/dev/null; then
          echo "UPX å‹ç¼©æˆåŠŸ"
          echo "å‹ç¼©åå¤§å°ï¼š"
          ls -lh dist/xdev-${{ matrix.target }}
        else
          echo "UPX å‹ç¼©å¤±è´¥æˆ–ä¸æ”¯æŒï¼Œä½¿ç”¨æœªå‹ç¼©ç‰ˆæœ¬"
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: xdev-${{ matrix.target }}
        path: dist/xdev-${{ matrix.target }}
        if-no-files-found: error

  release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ˜ç¡®å£°æ˜ release job éœ€è¦å†™å…¥æƒé™
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: é‡ç»„æ–‡ä»¶ç»“æ„
      run: |
        mkdir -p release
        # actions/download-artifact@v4 ä¸ºæ¯ä¸ª artifact åˆ›å»ºå•ç‹¬ç›®å½•
        echo "Artifacts ç›®å½•ç»“æ„:"
        find artifacts -type f -ls
        
        # å¤åˆ¶æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶åˆ° release ç›®å½•
        cp artifacts/*/xdev-* release/ 2>/dev/null || true
        
        # å¤‡ç”¨æ–¹æ³•ï¼šä½¿ç”¨ find å‘½ä»¤
        find artifacts -name "xdev-*" -type f -exec cp {} release/ \; 2>/dev/null || true
        
        echo "Release ç›®å½•å†…å®¹:"
        ls -la release/
        
        # éªŒè¯æ–‡ä»¶æ•°é‡
        file_count=$(ls -1 release/ | wc -l)
        echo "æ‰¾åˆ° $file_count ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶"
        
        if [ "$file_count" -eq 0 ]; then
          echo "é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°ä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶ï¼"
          echo "å®Œæ•´çš„ artifacts ç›®å½•ç»“æ„ï¼š"
          find artifacts -type f -name "*"
          exit 1
        fi

    - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      id: changelog
      run: |
        if [ -f CHANGELOG.md ]; then
          # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´å†…å®¹
          CURRENT_VERSION=${GITHUB_REF#refs/tags/}
          sed -n "/## $CURRENT_VERSION/,/## /p" CHANGELOG.md | sed '$d' > current_changelog.md
          if [ -s current_changelog.md ]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            cat current_changelog.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=æ­¤ç‰ˆæœ¬çš„è¯¦ç»†å˜æ›´å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²ã€‚" >> $GITHUB_OUTPUT
          fi
        else
          echo "CHANGELOG=æ­¤ç‰ˆæœ¬çš„è¯¦ç»†å˜æ›´å†…å®¹è¯·æŸ¥çœ‹æäº¤å†å²ã€‚" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        files: release/*
        body: |
          ## ğŸš€ xdev ${{ github.ref_name }}
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ### ğŸ“¦ æ”¯æŒçš„æ¶æ„
          - `xdev-x86_64-unknown-linux-gnu`: Linux x86_64
          - `xdev-aarch64-unknown-linux-gnu`: Linux ARM64
          - `xdev-x86_64-apple-darwin`: macOS Intel
          - `xdev-aarch64-apple-darwin`: macOS Apple Silicon
          
          ### ğŸ“¥ å®‰è£…æ–¹æ³• 1
          ```bash
          # æ‰§è¡Œ
          curl -Lsf https://raw.githubusercontent.com/loveloki/xdev/main/scripts/install.sh | sh
          ```

          ### ğŸ“¥ å®‰è£…æ–¹æ³• 2
          ```bash
          # ä¸‹è½½å¯¹åº”æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          # ä¸ºæ–‡ä»¶æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x xdev-*
          # ç§»åŠ¨åˆ° PATH ç›®å½•
          sudo mv xdev-* ~/.local/bin/xdev
          ```
          
          ---
          é€šè¿‡ GitHub Actions è‡ªåŠ¨æ„å»º ğŸ¤–
        draft: false
        prerelease: false
        fail_on_unmatched_files: false
        generate_release_notes: false 
